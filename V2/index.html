<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Insight Pro - Moteur de S√©ries</title>
    
    <!-- Import de la biblioth√®que Tailwind CSS via CDN pour le prototypage rapide -->
    <!-- Note : En production, il est pr√©f√©rable d'utiliser une build optimis√©e -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Police Inter pour un rendu moderne et lisible -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Styles personnalis√©s pour compl√©ter Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background: #0d111c; /* Fond tr√®s sombre pour le th√®me cin√©ma */
            color: #ffffff;
            min-height: 100vh;
        }
        
        /* D√©grad√© de couleur signature pour les titres et boutons */
        .bg-gradient-pro {
            background: linear-gradient(135deg, #1d4ed8 0%, #7c3aed 100%); /* Bleu vers Violet */
        }
        
        /* Couleur de fond des cartes (l√©g√®rement plus clair que le body) */
        .card-bg {
            background-color: #161b22; 
        }
        
        /* Styles des champs de saisie */
        .input-bg {
            background-color: #21262d; 
            border-color: #30363d;
        }
        
        /* Format standard pour les affiches de s√©ries */
        .serie-card-poster {
            height: 250px; 
            width: 100%;
            object-fit: cover; /* Assure que l'image remplit la zone sans d√©formation */
        }
        
        /* Badges pour les scores et les notes */
        .score-badge {
            background-color: #1d4ed8;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        /* Gestion de l'√©tat actif des onglets de navigation */
        .tab-button.active {
            background: linear-gradient(90deg, #1d4ed8, #7c3aed);
            color: white;
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.4);
        }
        .tab-button:not(.active) {
            background-color: #21262d;
            color: #a0aec0;
            transition: all 0.2s;
        }
        
        /* Effet de texte en d√©grad√© */
        .text-gradient-pro {
            background: linear-gradient(90deg, #1d4ed8, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        
        /* Ajustement responsive des modales */
        .modal-content {
            max-width: 90%;
            width: 600px;
        }
        @media (min-width: 768px) {
            .modal-content {
                max-width: 800px;
            }
        }
    </style>
</head>
<body class="text-white">
    <!-- Conteneur principal centr√© avec marges adaptatives -->
    <div class="container mx-auto p-4 md:p-10">
        
        <!-- En-t√™te : Titre et Bouton de connexion -->
        <header class="text-center mb-12 relative">
            <h1 class="text-4xl md:text-6xl font-black text-gradient-pro">
                üé¨ TV Insight Pro
            </h1>
            <p class="text-gray-400 mt-3 text-lg">Recherche s√©mantique avanc√©e et recommandations personnalis√©es.</p>

            <!-- Bouton de connexion positionn√© en absolu √† droite -->
            <div class="absolute top-0 right-0">
                <button onclick="openLoginModal()" id="loginButton" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-200">
                    Se connecter
                </button>
                <span id="authStatus" class="font-bold text-red-400 text-sm hidden"></span>
            </div>
            <!-- Champ cach√© pour stocker l'ID utilisateur courant -->
            <input type="hidden" id="userIdInput" value="">
        </header>

        <!-- Zone de Navigation et de Contr√¥le -->
        <div class="card-bg rounded-xl p-6 shadow-2xl mb-8 border border-gray-700">
            
            <!-- Barre d'onglets pour changer de vue -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button class="tab-button px-4 py-2 rounded-lg text-sm font-semibold active" data-tab="toutes">
                    Toutes les s√©ries
                </button>
                <button class="tab-button px-4 py-2 rounded-lg text-sm font-semibold" data-tab="recherche">
                    Recherche
                </button>
                <button class="tab-button px-4 py-2 rounded-lg text-sm font-semibold" data-tab="profil">
                    Recommandations
                </button>
                <button class="tab-button px-4 py-2 rounded-lg text-sm font-semibold" data-tab="vues">
                    S√©ries not√©es
                </button>
            </div>
            
            <!-- Contenu dynamique des onglets -->
            <div id="tab-container" class="pt-2">
                
                <!-- Onglet Recherche -->
                <div id="recherche-input" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Recherchez des mots-cl√©s dans les sous-titres (Ex: √©vasion prison, guerre civile, robot policier)"
                            class="flex-1 p-3 rounded-lg input-bg border border-gray-700 text-white placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500"
                            onkeypress="handleKeyPress(event)"
                        >
                        <button id="searchButton" onclick="rechercher()" class="bg-gradient-pro text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition duration-300">
                            Rechercher
                        </button>
                    </div>
                </div>
                
                <!-- Onglet Profil (Recommandations) -->
                <div id="profil-input" class="tab-content hidden">
                    <p id="profilMessage" class="text-gray-400 mb-4 font-medium"></p>
                    <button onclick="recommanderProfil()" id="recoProfilButton" class="bg-gradient-pro text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition duration-300 hidden">
                        Obtenir Recommandations
                    </button>
                </div>

                <!-- Onglet S√©ries Not√©es -->
                <div id="vues-input" class="tab-content hidden">
                    <p class="text-gray-400 mb-4">Liste des s√©ries que l'utilisateur a not√©es (n√©cessite la connexion).</p>
                </div>
                
                <!-- Onglet Toutes les s√©ries (contenu par d√©faut) -->
                <div id="toutes-input" class="tab-content">
                </div>
            </div> 
        </div>

        <!-- Barre de Statistiques (Temps de r√©ponse, nombre de r√©sultats) -->
        <div id="statsBar" class="card-bg rounded-xl p-4 shadow-lg mb-8 flex justify-around text-center text-sm border border-gray-700">
            <div class="stat-item">
                <div id="nbSeries" class="text-2xl font-bold text-indigo-400">?</div>
                <div class="text-gray-400">S√©ries index√©es</div>
            </div>
            <div class="stat-item">
                <div id="nbResultats" class="text-2xl font-bold text-purple-400">0</div>
                <div class="text-gray-400">R√©sultats affich√©s</div>
            </div>
            <div class="stat-item">
                <div id="tempsRecherche" class="text-2xl font-bold text-green-400">-</div>
                <div class="text-gray-400">Temps (ms)</div>
            </div>
        </div>
        
        <!-- Zones de Feedback Utilisateur -->
        <div id="errorMessage" class="hidden bg-red-700 text-white p-4 rounded-lg mb-4 font-semibold border border-red-500 shadow-lg"></div>
        <div id="loading" class="hidden text-center p-12 text-indigo-400 text-xl font-semibold">
             Chargement des donn√©es...
        </div>
        
        <p class="text-gray-500 text-center p-10" id="initialMessage">
            D√©marrer l'API Python sur `http://localhost:5001` pour charger les donn√©es.
        </p>
        
        <!-- Grille de R√©sultats (Cartes S√©ries) -->
        <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>
    </div>

    <!-- Modale d'Authentification (Connexion / Inscription) -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-bold mb-4 text-white text-gradient-pro" id="authTitle">Connexion</h2>
            
            <!-- Formulaire de Connexion -->
            <div id="loginForm" class="auth-form">
                <p class="text-gray-400 mb-4">Entrez vos identifiants.</p>
                <input 
                    type="email" 
                    id="loginEmailInput" 
                    placeholder="Email" 
                    class="w-full p-2 rounded input-bg border border-gray-700 text-white mb-3"
                >
                <input 
                    type="password" 
                    id="loginPasswordInput" 
                    placeholder="Mot de passe" 
                    class="w-full p-2 rounded input-bg border border-gray-700 text-white mb-6"
                    onkeypress="if(event.key === 'Enter') performLogin()"
                >
                <p id="loginError" class="text-red-400 text-sm mb-4 hidden font-medium"></p>
                
                <button onclick="performLogin()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition w-full mb-3">Connexion</button>
                <button onclick="showRegisterForm()" class="text-indigo-400 text-sm w-full hover:text-indigo-300 transition">Pas de compte ? S'inscrire</button>
            </div>

            <!-- Formulaire d'Inscription -->
            <div id="registerForm" class="auth-form hidden">
                <p class="text-gray-400 mb-4">Cr√©ez votre compte.</p>
                <input 
                    type="text" 
                    id="registerPseudoInput" 
                    placeholder="Pseudo (Optionnel)" 
                    class="w-full p-2 rounded input-bg border border-gray-700 text-white mb-3"
                >
                <input 
                    type="email" 
                    id="registerEmailInput" 
                    placeholder="Email" 
                    class="w-full p-2 rounded input-bg border border-gray-700 text-white mb-3"
                >
                <input 
                    type="password" 
                    id="registerPasswordInput" 
                    placeholder="Mot de passe (Min 6 caract√®res)" 
                    class="w-full p-2 rounded input-bg border border-gray-700 text-white mb-6"
                >
                 <p id="registerError" class="text-red-400 text-sm mb-4 hidden font-medium"></p>

                <button onclick="performRegister()" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 transition w-full mb-3">Cr√©er le compte</button>
                <button onclick="showLoginForm()" class="text-indigo-400 text-sm w-full hover:text-indigo-300 transition">J'ai d√©j√† un compte</button>
            </div>

            <button onclick="closeLoginModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition w-full mt-4">Fermer</button>
        </div>
    </div>

    <!-- Modale de D√©tails et de Notation -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-xl p-6 modal-content shadow-2xl border border-gray-700">
            <h2 class="text-3xl font-bold mb-4 text-white text-gradient-pro" id="detailTitle"></h2>
            
            <div class="flex flex-col md:flex-row gap-6 mb-6">
                <!-- Colonne Gauche : Affiche et Score -->
                <div class="md:w-1/3">
                    <img id="detailPoster" class="rounded-lg serie-card-poster object-cover shadow-xl" src="" alt="Affiche de la s√©rie">
                    <div id="detailScore" class="mt-4 text-sm font-semibold p-2 card-bg rounded-lg"></div>
                </div>
                
                <!-- Colonne Droite : Infos et Notation -->
                <div class="md:w-2/3">
                    <h3 class="text-lg font-semibold text-gray-400 border-b border-gray-700 pb-2 mb-3">R√©sum√©</h3>
                    <p id="detailSummary" class="text-gray-300 mb-6 text-sm"></p>
                    
                    <h3 class="text-lg font-semibold text-gray-400 border-b border-gray-700 pb-2 mb-3">Votre √âvaluation</h3>

                    <!-- Section Notation (Visible uniquement si connect√©) -->
                    <div id="ratingSection" class="flex flex-col items-center">
                        <p id="currentRatingInfo" class="text-sm text-gray-400 mb-3 hidden">Votre note actuelle : <span class="text-yellow-400 font-bold" id="currentNoteValue"></span></p>

                        <div id="rateControls">
                            <p class="text-gray-300 mb-2">Noter de 1 √† 5 √©toiles :</p>
                            <!-- Conteneur pour les √©toiles interactives -->
                            <div id="detailStarContainer" class="flex justify-center text-4xl space-x-2 cursor-pointer mb-6">
                                </div>
                            <button onclick="submitRating()" id="saveRatingButton" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition w-full">Enregistrer la Note</button>
                        </div>
                        
                        <button onclick="deleteRating()" id="deleteRatingButton" class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700 transition w-full mt-3 hidden">Supprimer ma Note</button>
                    </div>

                    <!-- Message d'invitation √† la connexion -->
                    <p id="authPrompt" class="text-red-400 text-sm mt-4 text-center hidden">Connectez-vous pour noter cette s√©rie.</p>
                </div>
            </div>

            <button onclick="closeDetailsModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition w-full mt-4">Fermer</button>
        </div>
    </div>


    <script>
        // Configuration de l'URL de l'API Flask (backend)
        const API_URL = 'http://localhost:5001/api';
        
        // √âtat global de l'application
        let currentTab = 'toutes';
        let selectedRating = 0;
        let selectedSerieId = null;
        let loggedInUserId = null; 
        let loggedInPseudo = null;

        // --- Fonctions d'Alignement (Coh√©rent avec le Python) ---
        // Sert √† normaliser les noms pour correspondre aux cl√©s de la BDD
        function alignerNomBdd(nomSerie) {
            if (!nomSerie) return "";
            let nom = nomSerie.toLowerCase().replace(/ /g, '');
            // Ne garde que les caract√®res alphanum√©riques et accents fran√ßais
            nom = nom.replace(/[^a-z0-9√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø√±√¶≈ì]/g, ''); 
            return nom;
        }

        // --- Gestion de l'Authentification et de l'Interface Utilisateur ---

        // Bascule vers le formulaire de connexion
        function showLoginForm() {
            document.getElementById('authTitle').textContent = 'Connexion';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('registerError').classList.add('hidden');
        }

        // Bascule vers le formulaire d'inscription
        function showRegisterForm() {
            document.getElementById('authTitle').textContent = 'Inscription';
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('registerError').classList.add('hidden');
        }

        // Met √† jour l'interface selon l'√©tat de connexion (connect√©/d√©connect√©)
        function updateAuthStatus(userId, pseudo = null) {
            const loginButton = document.getElementById('loginButton');
            const recoButton = document.getElementById('recoProfilButton');
            const profilMessage = document.getElementById('profilMessage');

            // Mise √† jour de l'√©tat global
            loggedInPseudo = pseudo;
            loggedInUserId = userId;

            if (userId) {
                // Mode Connect√© : Affiche le pseudo et le bouton d√©connexion
                loginButton.textContent = `${pseudo || 'Utilisateur'} (D√©connexion)`;
                loginButton.classList.remove('bg-indigo-600');
                loginButton.classList.add('bg-gray-700');
                loginButton.onclick = performLogout;
                
                // Active les fonctionnalit√©s li√©es au profil
                profilMessage.textContent = 'Cliquez pour obtenir vos recommandations personnalis√©es.';
                profilMessage.classList.remove('text-red-400');
                recoButton.classList.remove('hidden');
            } else {
                // Mode D√©connect√© : Bouton de connexion standard
                loginButton.textContent = 'Se connecter';
                loginButton.classList.add('bg-indigo-600');
                loginButton.classList.remove('bg-gray-700');
                loginButton.onclick = openLoginModal;
                
                // Bloque les fonctionnalit√©s profil
                profilMessage.textContent = 'Veuillez vous connecter pour obtenir des recommandations par profil.';
                profilMessage.classList.add('text-red-400');
                recoButton.classList.add('hidden');
            }
            
            // Recharge l'onglet actuel pour mettre √† jour les droits (ex: boutons de notation)
            switchTab(currentTab, true);
        }

        // Ouvre la modale d'authentification
        function openLoginModal() {
            showLoginForm();
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        // Ex√©cute la requ√™te de connexion vers l'API
        async function performLogin() {
            const email = document.getElementById('loginEmailInput').value.trim();
            const password = document.getElementById('loginPasswordInput').value.trim();
            const errorElement = document.getElementById('loginError');
            errorElement.classList.add('hidden');

            // Validation simple c√¥t√© client
            if (!email || !password) {
                errorElement.textContent = "Veuillez remplir tous les champs.";
                errorElement.classList.remove('hidden');
                return;
            }

            try {
                // Appel API
                const data = await fetchAPI('utilisateur/connexion', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                // En cas de succ√®s, mise √† jour de l'√©tat
                updateAuthStatus(data.user_id, data.pseudo);
                closeLoginModal();

            } catch (error) {
                // Gestion des erreurs (ex: mot de passe incorrect)
                const message = error.message.replace('API: Error: ', '').replace('API: ', '');
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        // Ex√©cute la requ√™te d'inscription vers l'API
        async function performRegister() {
            const pseudo = document.getElementById('registerPseudoInput').value.trim();
            const email = document.getElementById('registerEmailInput').value.trim();
            const password = document.getElementById('registerPasswordInput').value.trim();
            const errorElement = document.getElementById('registerError');
            errorElement.classList.add('hidden');

            if (!email || !password || password.length < 6) {
                errorElement.textContent = "Email et mot de passe (min 6 caract√®res) sont requis.";
                errorElement.classList.remove('hidden');
                return;
            }

            try {
                await fetchAPI('utilisateur/inscription', {
                    method: 'POST',
                    body: JSON.stringify({ pseudo, email, password })
                });
                // Une fois inscrit, on redirige vers le formulaire de connexion
                showLoginForm();

            } catch (error) {
                const message = error.message.replace('API: Error: ', '').replace('API: ', '');
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        // D√©connexion simple (effacement de l'√©tat local)
        function performLogout() {
            updateAuthStatus(null);
            switchTab('toutes');
        }
        
        function getUserId() {
            return loggedInUserId;
        }


        // --- Fonctions Utilitaires et de Contr√¥le ---

        // Met √† jour la barre de statistiques en haut de page
        function updateStats(nbResultats = 0, tempsMs = '-', nbSeries = null) {
            document.getElementById('nbResultats').textContent = nbResultats;
            document.getElementById('tempsRecherche').textContent = tempsMs;
            if (nbSeries !== null) {
                document.getElementById('nbSeries').textContent = nbSeries;
            }
        }

        // G√®re la classe active sur les boutons d'onglets
        function setActiveButton(tab) {
            document.querySelectorAll('.tab-button').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tab) {
                    t.classList.add('active');
                }
            });
        }
        
        // Affiche ou masque l'indicateur de chargement
        function afficherChargement(afficher) {
            document.getElementById('loading').classList.toggle('hidden', !afficher);
            if (afficher) {
                document.getElementById('results').innerHTML = ''; // Nettoie les r√©sultats pr√©c√©dents
                document.getElementById('initialMessage').classList.add('hidden');
            }
        }

        // Affiche un message d'erreur global
        function afficherErreur(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('results').innerHTML = '';
            document.getElementById('initialMessage').classList.add('hidden');
            updateStats(0, '-');
        }

        function cacherErreur() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Permet de lancer la recherche avec la touche Entr√©e
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                if (currentTab === 'recherche') rechercher();
            }
        }

        // Logique principale de changement d'onglet
        function switchTab(tab, forceReload = false) {
            currentTab = tab;
            setActiveButton(tab);
            
            // Masquer tout le contenu des onglets
            document.querySelectorAll('.tab-content').forEach(element => {
                element.classList.add('hidden'); 
            });
            
            document.getElementById('results').innerHTML = '';
            cacherErreur();
            
            const initialMsg = document.getElementById('initialMessage');
            if (initialMsg) {
                initialMsg.classList.add('hidden');
            }

            // Afficher le contenu de l'onglet s√©lectionn√© (ex: barre de recherche)
            const targetInputId = tab + '-input';
            const targetElement = document.getElementById(targetInputId);
            if (targetElement) {
                targetElement.classList.remove('hidden');
            }
            
            // Logique de chargement des donn√©es selon l'onglet
            if (tab === 'toutes') {
                chargerToutesSeries(); 
            } else if (tab === 'vues') {
                if (!loggedInUserId) {
                     afficherErreur("Veuillez vous connecter pour voir vos s√©ries not√©es.");
                } else {
                     chargerSeriesVues();
                }
            } else if (tab === 'profil') {
                 if (!loggedInUserId) {
                     afficherErreur("Veuillez vous connecter pour obtenir des recommandations.");
                 }
                 // Sinon, on attend que l'utilisateur clique sur le bouton
            } else if (tab === 'recherche') {
                 // Charge le nombre total de s√©ries index√©es pour info
                 fetchAPI(`series`)
                    .then(data => updateStats(0, '-', data.nombre_series))
                    .catch(() => updateStats(0, '-', 'Erreur'));
            }
            // Si on ne recharge pas les r√©sultats (ex: juste apr√®s la connexion), on garde les stats
            if (!forceReload) {
                updateStats(0, '-');
            }
        }

        // --- Modale D√©tails et Syst√®me de Notation ---
        
        // Ouvre la modale avec les d√©tails de la s√©rie cliqu√©e
        async function openDetailsModal(serie) {
            selectedSerieId = serie.id;
            
            document.getElementById('detailTitle').textContent = serie.nom || 'S√©rie Inconnue';
            document.getElementById('detailSummary').textContent = serie.resume || 'Aucun r√©sum√© disponible.';
            
            const posterUrl = serie.affiche_url || `https://placehold.co/400x250/21262d/a855f7?text=Affiche+Manquante`;
            document.getElementById('detailPoster').src = posterUrl;
            document.getElementById('detailPoster').alt = `Affiche de ${serie.nom}`;

            // Construction de l'affichage du score selon le contexte (Recherche, Profil, etc.)
            let scoreText = `Langue Originale: ${serie.langue_originale || 'N/A'}`;
            if (serie.score_similarite) {
                scoreText += `<br>Score Similarit√©: ${serie.score_similarite.toFixed(4)}`;
            } else if (serie.score_profil) {
                scoreText += `<br>Score Profil: ${serie.score_profil.toFixed(4)}`;
            } else if (serie.score) {
                 scoreText += `<br>Score Recherche: ${serie.score.toFixed(4)}`;
            } else if (serie.note) {
                 scoreText += `<br>Votre Note: ‚≠ê ${serie.note} / 5`;
            } else if (serie.note_moyenne) {
                 scoreText += `<br>Note Moyenne: ‚≠ê ${serie.note_moyenne.toFixed(1)} / 5 (${serie.nb_notes} notes)`;
            }
            document.getElementById('detailScore').innerHTML = scoreText;

            // Gestion de l'affichage de la section notation
            const ratingSection = document.getElementById('ratingSection');
            const authPrompt = document.getElementById('authPrompt');
            const currentRatingInfo = document.getElementById('currentRatingInfo');
            const deleteButton = document.getElementById('deleteRatingButton');
            const starContainer = document.getElementById('detailStarContainer');
            
            starContainer.innerHTML = '';
            deleteButton.classList.add('hidden');
            currentRatingInfo.classList.add('hidden');
            
            if (loggedInUserId) {
                // Si connect√©, on affiche les √©toiles
                ratingSection.classList.remove('hidden');
                authPrompt.classList.add('hidden');
                
                let userNote = serie.note || 0; 
                
                // Si la note n'est pas d√©j√† charg√©e, on va la chercher en BDD
                if (userNote === 0 && currentTab !== 'vues') {
                    try {
                        const noteData = await fetchAPI(`utilisateur/${loggedInUserId}/series/${selectedSerieId}/note`);
                        userNote = noteData.note || 0;
                    } catch (e) {
                        console.error("Impossible de r√©cup√©rer la note de l'utilisateur:", e.message);
                    }
                }
                
                if (userNote > 0) {
                    currentRatingInfo.classList.remove('hidden');
                    document.getElementById('currentNoteValue').textContent = `${userNote} / 5`;
                    deleteButton.classList.remove('hidden');
                }

                // G√©n√©ration dynamique des √©toiles interactives
                selectedRating = userNote;
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.textContent = '‚òÖ';
                    // Classe conditionnelle pour colorer les √©toiles s√©lectionn√©es
                    star.className = `cursor-pointer transition duration-150 ${i <= userNote ? 'text-yellow-400' : 'text-gray-500'}`;
                    star.onclick = () => selectDetailRating(i);
                    starContainer.appendChild(star);
                }

            } else {
                // Si d√©connect√©, on affiche l'invitation √† se connecter
                ratingSection.classList.add('hidden');
                authPrompt.classList.remove('hidden');
            }

            document.getElementById('detailsModal').classList.remove('hidden');
        }

        // G√®re la s√©lection visuelle des √©toiles
        function selectDetailRating(rating) {
            selectedRating = rating;
            const stars = document.getElementById('detailStarContainer').children;
            for (let i = 0; i < 5; i++) {
                stars[i].classList.toggle('text-yellow-400', i < rating);
                stars[i].classList.toggle('text-gray-500', i >= rating);
            }
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            selectedSerieId = null;
            selectedRating = 0;
        }

        // Supprime la note de l'utilisateur pour la s√©rie courante
        async function deleteRating() {
             const serieIdToDelete = selectedSerieId;
             if (!loggedInUserId || !serieIdToDelete) {
                 alert('Erreur critique : ID de s√©rie ou utilisateur manquant pour la suppression.');
                 return;
             }

             closeDetailsModal();
             afficherChargement(true);

             try {
                // Appel √† la route DELETE de l'API
                const response = await fetchAPI(`utilisateur/${loggedInUserId}/series/${serieIdToDelete}/note`, {
                    method: 'DELETE'
                });
                
             } catch (error) {
                 const message = error.message.includes('404') ? "Erreur: Note non trouv√©e." : error.message;
                 afficherErreur('API: ' + message);
             } finally {
                 afficherChargement(false);
                 switchTab(currentTab, true); // Recharge la vue pour mettre √† jour l'affichage
             }
        }

        // Envoie la note au serveur
        async function submitRating() {
            if (!selectedSerieId || selectedRating === 0 || !loggedInUserId) {
                alert('Veuillez s√©lectionner une note de 1 √† 5 √©toiles.');
                return;
            }

            const userId = loggedInUserId;
            const dataToSend = { serie_id: selectedSerieId, note: selectedRating }; 
            
            closeDetailsModal();
            afficherChargement(true);
            
            try {
                await fetchAPI(`utilisateur/${userId}/noter`, { 
                    method: 'POST',
                    body: JSON.stringify(dataToSend) 
                });

            } catch (error) {
                // L'erreur est g√©r√©e dans fetchAPI
            } finally {
                afficherChargement(false);
                switchTab(currentTab, true);
            }
        }

        // --- Fonctions d'Interaction avec l'API Flask (Wrapper Fetch) ---

        async function fetchAPI(endpoint, options = {}) {
            const defaultOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                ...options
            };
            
            try {
                const response = await fetch(`${API_URL}/${endpoint}`, defaultOptions);
                
                // Gestion de la r√©ponse JSON ou Texte
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await response.json() : await response.text();

                if (!response.ok) {
                    const message = isJson && data.error ? data.error : `Erreur HTTP ${response.status} sur ${endpoint}`;
                    throw new Error(message);
                }

                return data;
            } catch (error) {
                if (endpoint === 'series') {
                     // Message sp√©cifique pour l'√©chec de chargement initial
                     afficherErreur(`√âCHEC DE LA CONNEXION √Ä L'API: V√©rifiez que l'API Flask est lanc√©e sur ${API_URL}`);
                } else {
                     afficherErreur('API: ' + error.message);
                }
                
                throw error;
            }
        }

        // Lance la recherche par mots-cl√©s
        async function rechercher() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                afficherErreur('Veuillez entrer un terme de recherche');
                return;
            }

            afficherChargement(true);
            try {
                const data = await fetchAPI(`recherche?q=${encodeURIComponent(query)}&limit=50`); 
                updateStats(data.nombre_resultats, data.temps_recherche_ms);
                // Affiche les r√©sultats avec le score de recherche
                afficherResultats(data.resultats, 'score', true); 
            } catch (error) {
            } finally {
                afficherChargement(false);
            }
        }

        // Demande des recommandations bas√©es sur le profil utilisateur
        async function recommanderProfil() {
            const userId = getUserId();
            if (!userId) {
                 afficherErreur("Veuillez vous connecter pour utiliser la recommandation par profil.");
                 return;
            }
            
            afficherChargement(true);
            try {
                // 1. R√©cup√®re les s√©ries aim√©es
                const vuesData = await fetchAPI(`utilisateur/${userId}/series`);
                
                const seriesAimeesSlugs = vuesData.series.map(s => alignerNomBdd(s.nom));

                if (seriesAimeesSlugs.length === 0) {
                     afficherErreur("Vous devez noter au moins une s√©rie pour obtenir des recommandations par profil.");
                     return;
                }

                // 2. Demande des recommandations bas√©es sur ces s√©ries
                const data = await fetchAPI(`recommandations/profil`, {
                    method: 'POST',
                    body: JSON.stringify({ series_aimees: seriesAimeesSlugs, limit: 10 })
                });
                
                updateStats(data.nombre_recommandations, data.temps_reco_ms);
                afficherResultats(data.recommandations, 'score_profil', false);

            } catch (error) {
            } finally {
                afficherChargement(false);
            }
        }

        // Charge l'historique des s√©ries not√©es
        async function chargerSeriesVues() {
            const userId = getUserId();
            if (!userId) return; 

            afficherChargement(true);
            try {
                const data = await fetchAPI(`utilisateur/${userId}/series`);
                updateStats(data.nombre_series, '-');
                // isVues = true affiche l'indicateur de note sur la carte
                afficherResultats(data.series, 'note', false, true); 
            } catch (error) {
            } finally {
                afficherChargement(false);
            }
        }

        // Charge toutes les s√©ries disponibles (sans filtre)
        async function chargerToutesSeries() {
            afficherChargement(true);
            try {
                const data = await fetchAPI(`series`);
                updateStats(data.nombre_series, '-');
                afficherResultats(data.series, 'N/A', false); 
            } catch (error) {
            } finally {
                afficherChargement(false);
            }
        }

        // --- Fonction de rendu des cartes de s√©ries (HTML Dynamique) ---

        function afficherResultats(series, scoreKey, isSearch, isVues = false) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ''; // Vide la grille
            document.getElementById('initialMessage').classList.add('hidden'); 

            if (series.length === 0) {
                resultsDiv.innerHTML = '<p class="text-gray-400 col-span-full text-center p-10">Aucun r√©sultat trouv√©.</p>';
                return;
            }

            series.forEach(serie => {
                // Cr√©ation de l'√©l√©ment carte
                const card = document.createElement('div');
                card.className = 'card-bg rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.02] relative border border-gray-700 cursor-pointer';
                card.onclick = () => openDetailsModal(serie); // Attache l'√©v√©nement clic

                const scoreValue = serie[scoreKey] !== undefined ? serie[scoreKey] : null;
                const displayName = serie.nom || 'Nom Indisponible'; 
                const firstChar = (displayName && displayName !== 'Nom Indisponible') ? displayName.substring(0, 1) : '?';

                // G√©n√©ration du badge de note (√©toile jaune)
                let indicatorHTML = '';
                if (isVues || serie.note) {
                    indicatorHTML = `<span class="score-badge bg-yellow-500 text-black absolute top-3 right-3 text-sm">‚≠ê ${serie.note || 'N/A'}</span>`;
                }
                
                // G√©n√©ration du badge de score (recherche/reco)
                const scoreHTML = scoreValue !== null && scoreKey !== 'N/A' && scoreKey !== 'note'
                    ? `<span class="score-badge">${scoreKey.toUpperCase().replace('_', ' ')}: ${scoreValue.toFixed(4)}</span>`
                    : (isSearch ? `<span class="score-badge bg-gray-600">Score Total: ${serie.score ? serie.score.toFixed(4) : 'N/A'}</span>` : ``);

                // Gestion de l'image (avec fallback en cas d'erreur de chargement)
                const posterHTML = serie.affiche_url 
                    ? `<img src="${serie.affiche_url}" alt="${displayName}" class="serie-card-poster object-cover object-center" onerror="this.onerror=null;this.src='https://placehold.co/400x250/21262d/a855f7?text=${displayName.substring(0, 15).replace(/\s/g, '+')}';">`
                    : `<div class="serie-card-poster flex items-center justify-center bg-gray-600 text-5xl font-bold text-gray-300">${firstChar}</div>`;

                // Injection du HTML dans la carte
                card.innerHTML += `
                    ${posterHTML}
                    ${indicatorHTML}
                    <div class="p-4">
                        <div class="text-xl font-bold text-white truncate">${displayName}</div>
                        <div class="text-sm text-gray-400 mt-2 flex justify-between items-center">
                            ${scoreHTML}
                            <span class="text-xs text-gray-500">${serie.langue_originale || 'Langue Inconnue'}</span>
                        </div>
                        <p class="text-gray-500 text-sm mt-3 line-clamp-2">${serie.resume || 'Aucun r√©sum√© disponible.'}</p>
                    </div>
                `;

                resultsDiv.appendChild(card);
            });
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthStatus(null); 
            // Attache les √©v√©nements aux boutons d'onglets
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (event) => switchTab(button.dataset.tab));
            });
            // Charge l'onglet par d√©faut
            switchTab('toutes'); 
        });
    </script>
</body>
</html>